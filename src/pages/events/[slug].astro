---
// src/pages/events/[slug].astro
import { setCache } from "../../utils/cache";
import { getEventBySlug, getEvents } from "./../../utils/events";

import MapDisplay from "../../components/MapDisplay.astro"; // Import the map component
import BaseLayout from "../../layouts/BaseLayout.astro";
import NotFoundLayout from "../../layouts/NotFoundLayout.astro";

export async function getStaticPaths() {
  const events = await getEvents();
  return events.map((event) => ({
    params: { slug: event.slug },
  }));
}

const { slug } = Astro.params;
const event = await getEventBySlug(slug || "");

if (!event) {
  Astro.response.status = 404;
}

setCache.short(Astro as any);

const eventDate = event ? new Date(event.date).toLocaleDateString("en-US", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
}) : '';

const eventTime = event ? new Date(event.date).toLocaleTimeString("en-US", {
  hour: "2-digit",
  minute: "2-digit",
}) : '';

// Generate Google Maps directions link
const googleMapsDirectionsLink = event
  ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.address)}&travelmode=driving`
  : '#';
---

{
  !event ? (
    <NotFoundLayout title="Event not found" message="Event not found" />
  ) : (
    <BaseLayout title={event.title}>
      <div class="container pt-6">
        <nav class="text-sm breadcrumbs mb-4">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/events">Events</a></li>
            <li>{event.title}</li>
          </ul>
        </nav>

        <section class="pb-16 pt-6 lg:grid lg:grid-cols-12 lg:gap-20">
          <div class="lg:col-span-7">
            {event.imageUrl && (
              <img
                src={event.imageUrl}
                alt={event.title}
                class="w-full h-auto object-cover rounded-lg shadow-md mb-6"
              />
            )}
            <h1 class="text-4xl font-bold mb-4">{event.title}</h1>
            <p class="text-gray-700 text-lg mb-6">{event.description}</p>
          </div>

          <div class="mt-8 lg:col-span-5 lg:mt-0">
            <div class="bg-gray-50 p-6 rounded-lg shadow-md">
              <h2 class="text-2xl font-semibold mb-4">Event Details</h2>
              <p class="mb-2">
                <strong class="font-medium">Date:</strong> {eventDate}
              </p>
              <p class="mb-2">
                <strong class="font-medium">Time:</strong> {eventTime}
              </p>
              <p class="mb-2">
                <strong class="font-medium">Location:</strong> {event.locationName}
              </p>
              <p class="text-gray-700 mb-4">{event.address}</p>

              <h3 class="text-xl font-semibold mb-3">Location Map</h3>
              <MapDisplay
                client:load
                latitude={event.latitude}
                longitude={event.longitude}
                locationName={event.locationName}
              />

              <a
                href={googleMapsDirectionsLink}
                target="_blank"
                rel="noopener noreferrer"
                class="mt-4 w-full inline-block text-center bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-md transition-colors duration-200 ease-in-out"
              >
                Get Directions on Google Maps
              </a>
            </div>
            {/* You could add related products here if event tickets are products */}
            {/* <section class="container mt-8">
              <ProductRecommendations productId={product.id} buyerIP={ip} />
            </section> */}
          </div>
        </section>
      </div>
    </BaseLayout>
  )
}